version: "3.4"

services:
  pg_db:
      container_name: pg_db
      image: postgres:15-bullseye
      environment:
        POSTGRES_DB: "authn"
        POSTGRES_USER: ${pg_user}
        POSTGRES_PASSWORD: ${pg_pass}
      ports:
        - "5432:5432"
      volumes:
        - /home/authn/repo/db_data:/var/lib/postgresql/data

  authn_service:
    #image: cybercucumber/authn_service:latest
    container_name: py_service
    build:
      context: .
      dockerfile: Dockerfile
    environment:
      DB_USER: ${pg_user}
      DB_PASS: ${pg_pass}
      DB_LOC: "pg_db"
      DB_PORT: "5432"
      DB_TABLE: "authn"

  nginx:
    container_name: nginx
    build:
      context: .
      dockerfile: Dockerfile.nginx
    depends_on:
      - authn_service
    ports:
      - 80:80
    volumes:
      - /home/authn/repo/nginx-logs:/var/log/nginx
secrets:
  - ./ansible/roles/decrypt/secret.yaml  
